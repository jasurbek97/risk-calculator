<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Trade Risk Calculator</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#121722; --muted:#778; --text:#e8ecf2; --accent:#6ee7b7; --accent2:#7aa2ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b0d12,#0c1018 40%,#0b0d12);color:var(--text);min-height:100vh}
    
    /* Responsive Container */
    .container{max-width:1200px;margin:16px auto;padding:12px}
    @media(min-width:480px){.container{margin:20px auto;padding:16px}}
    @media(min-width:768px){.container{margin:40px auto;padding:24px}}
    
    .card{background:var(--panel);border:1px solid #1e2635;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    @media(min-width:768px){.card{border-radius:18px}}
    
    /* Responsive Header */
    .header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:16px 16px 8px 16px;flex-direction:column}
    @media(min-width:640px){.header{flex-direction:row;align-items:center;gap:16px}}
    @media(min-width:768px){.header{padding:22px 22px 10px 22px}}
    
    .title{font-size:18px;font-weight:700;letter-spacing:.2px;margin-bottom:8px}
    @media(min-width:480px){.title{font-size:20px}}
    @media(min-width:768px){.title{font-size:22px;margin-bottom:0}}
    
    .subtitle{font-size:13px;color:var(--muted);line-height:1.4;margin-bottom:12px}
    @media(min-width:640px){.subtitle{margin-bottom:0}}
    @media(min-width:768px){.subtitle{font-size:14px}}
    
    /* Responsive Grid */
    .grid{display:grid;gap:12px;padding:0 16px 16px 16px}
    @media(min-width:480px){.grid{gap:14px}}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:768px){.grid{padding:0 22px 22px 22px}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    
    .grid.single{grid-template-columns:1fr}
    
    /* Responsive Typography */
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:500}
    @media(min-width:768px){label{font-size:12px}}
    
    input,textarea,button{font:inherit}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #243047;background:#0f1320;color:var(--text);font-size:14px}
    @media(min-width:768px){.input{padding:12px;border-radius:12px;font-size:15px}}
    
    /* Responsive Buttons */
    .row{display:flex;gap:8px;align-items:center;width:100%;justify-content:flex-end}
    @media(min-width:640px){.row{width:auto}}
    
    .btn{cursor:pointer;border:1px solid #22304a;background:#0f1422;color:#dfe6f3;padding:8px 12px;border-radius:10px;transition:.15s ease;font-size:13px;white-space:nowrap;flex:1}
    @media(min-width:640px){.btn{flex:initial}}
    @media(min-width:768px){.btn{padding:10px 14px;border-radius:12px;font-size:14px}}
    .btn:hover{transform:translateY(-1px);border-color:#2f436d}
    .btn.accent{border-color:#1b3e36;background:#0f1f1a;color:#d8f5ea}
    .btn.accent:hover{box-shadow:0 6px 20px rgba(110,231,183,.15)}
    .btn.ghost{background:transparent}

    /* Responsive Table */
    .table-container{padding:0 16px 16px 16px;overflow-x:auto}
    @media(min-width:768px){.table-container{padding:0 22px 18px 22px}}
    
    table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:700px}
    @media(min-width:768px){table{border-spacing:0 10px;min-width:800px}}
    
    th,td{padding:8px 6px;text-align:left;font-size:10px}
    @media(min-width:480px){th,td{padding:10px 8px;font-size:11px}}
    @media(min-width:768px){th,td{padding:12px 14px;font-size:12px}}
    @media(min-width:1024px){th,td{font-size:13px}}
    
    th{color:#9aa7c7;border-bottom:1px solid #23314c;font-weight:600}
    tr{background:#0f1422;border:1px solid #1d2740}
    tr td:first-child, tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tr td:last-child, tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
    @media(min-width:768px){
      tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
      tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    }

    /* Responsive Pills */
    .pills{padding:8px 16px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    @media(min-width:768px){.pills{padding:12px 22px 4px 22px;gap:10px}}
    
    .pill{display:inline-block;padding:3px 6px;border-radius:999px;background:#0d192e;border:1px solid #22324f;color:#cfe;font-size:9px}
    @media(min-width:480px){.pill{padding:3px 8px;font-size:10px}}
    @media(min-width:768px){.pill{padding:4px 10px;font-size:11px}}
    
    /* Responsive Footer */
    .foot{padding:12px 16px 16px 16px;color:#9aa7c7;font-size:10px;display:flex;flex-direction:column;gap:8px}
    @media(min-width:768px){.foot{padding:12px 22px 22px 22px;font-size:12px;flex-direction:row;justify-content:space-between;align-items:center;gap:16px}}
    
    .muted{color:#9aa7c7}
    .danger{color:var(--danger)}
    
    #totals{font-weight:600;color:var(--text);font-size:10px}
    @media(min-width:768px){#totals{font-size:12px}}
    
    /* Mobile Table Optimizations */
    @media(max-width:600px){
      table{min-width:600px}
      th:nth-child(n+6), td:nth-child(n+6){font-size:9px}
    }
    
    /* Table scroll hint */
    .table-scroll-hint{display:block;text-align:center;font-size:9px;color:var(--muted);padding:4px 16px;border-top:1px solid #1e2635}
    @media(min-width:768px){.table-scroll-hint{display:none}}
    
    /* Landscape phone optimizations */
    @media(max-width:767px) and (orientation:landscape){
      .container{margin:8px auto;padding:8px}
      .header{padding:12px 16px 6px 16px}
      .grid{padding:0 16px 12px 16px;gap:10px}
      .pills{padding:6px 16px}
      .table-container{padding:0 16px 12px 16px}
      .foot{padding:8px 16px 12px 16px}
    }
    
    /* Very small screens */
    @media(max-width:360px){
      .title{font-size:16px}
      .btn{padding:6px 8px;font-size:12px}
      th,td{padding:6px 4px;font-size:9px}
      table{min-width:500px}
    }
    
    /* Risk Warning Styles */
    .risk-warning{
      margin:8px 16px;
      padding:12px;
      background:rgba(255,107,107,0.1);
      border:1px solid var(--danger);
      border-radius:10px;
      animation:warningPulse 2s infinite;
    }
    @media(min-width:768px){
      .risk-warning{
        margin:12px 22px;
        padding:16px;
        border-radius:12px;
      }
    }
    
    .warning-content{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    
    .warning-icon{
      font-size:16px;
      animation:warningShake 1s infinite;
    }
    @media(min-width:768px){
      .warning-icon{font-size:18px}
    }
    
    .warning-text{
      color:var(--danger);
      font-weight:600;
      font-size:12px;
    }
    @media(min-width:768px){
      .warning-text{font-size:14px}
    }
    
    @keyframes warningPulse{
      0%, 100%{border-color:var(--danger);background:rgba(255,107,107,0.1)}
      50%{border-color:#ff8a8a;background:rgba(255,107,107,0.2)}
    }
    
    @keyframes warningShake{
      0%, 100%{transform:translateX(0)}
      25%{transform:translateX(-2px)}
      75%{transform:translateX(2px)}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Crypto Trade Risk Calculator</div>
          <div class="subtitle">Size positions by risk, not feelings. Set capital, entry, take-profits—Stop-Loss auto-calculates.</div>
        </div>
        <div class="row">
          <button id="reset" class="btn ghost" title="Reset to defaults">Reset</button>
          <button id="download" class="btn accent" title="Download table as SVG">Download SVG</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="capital">Capital (USDT)</label>
          <input id="capital" type="number" class="input" value="5000" min="0" step="0.01">
        </div>
        <div>
          <label for="entry">Entry Price</label>
          <input id="entry" type="number" class="input" value="111500" min="0" step="0.01">
        </div>
        <div>
          <label for="riskdist">Default Stop % Below Entry</label>
          <input id="riskdist" type="number" class="input" value="3" min="0.1" step="0.1">
        </div>
        <div>
          <label for="risks">Risk % per Trade (comma-separated)</label>
          <input id="risks" type="text" class="input" value="1,2" placeholder="e.g., 0.5, 1, 1.5, 2">
        </div>
      </div>

      <div class="grid single">
        <div>
          <label for="tps">Take-Profits (comma-separated)</label>
          <input id="tps" type="text" class="input" value="114500,118000,122000" placeholder="Add one or many, separated by commas">
        </div>
      </div>

      <div class="pills">
        <span class="pill">RR ≥ 2 preferred</span>
        <span class="pill">Risk only 1–2%/trade</span>
        <span class="pill danger">Never move SL away</span>
      </div>

      <div id="risk-warning" class="risk-warning" style="display: none;">
        <div class="warning-content">
          <span class="warning-icon">⚠️</span>
          <span class="warning-text">Too Risky - Total Stop Loss exceeds 2% of capital</span>
        </div>
      </div>

      <div class="table-container">
        <table id="results">
          <thead>
            <tr>
              <th>Stop Loss %</th>
              <th>Stop Loss $</th>
              <th>Investment (USDT)</th>
              <th>Investment (Crypto)</th>
              <th>Stop Exit</th>
              <th>Take Profit Exit</th>
              <th>Profit $</th>
              <th>R:R</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-scroll-hint">← Scroll horizontally to see all columns →</div>
      </div>

      <div class="foot">
        <span>Stop = Entry − (Entry × stop%). Position = (capital × risk%) / (Entry − Stop).</span>
        <span id="totals"></span>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n, d=2)=> {
      // Ensure n is a valid number
      const num = Number(n);
      if (!isFinite(num)) return '0';
      
      // Ensure d is within valid range (0-20)
      const digits = Math.max(0, Math.min(20, Math.floor(Number(d) || 0)));
      
      try {
        return num.toLocaleString(undefined, {
          maximumFractionDigits: digits, 
          minimumFractionDigits: (num % 1 ? Math.min(digits, 2) : 0)
        });
      } catch (e) {
        return num.toString();
      }
    };

    function parsePercents(str){
      return String(str)
        .split(',')
        .map(s=>parseFloat(s.trim()))
        .filter(v=>!isNaN(v) && v>0)
        .map(v=>v/100);
    }
    function parsePrices(str){
      return String(str)
        .split(',')
        .map(s=>parseFloat(s.trim()))
        .filter(v=>!isNaN(v) && v>0);
    }
    
    // function autoCalculateTakeProfits(){
    //   const entry = parseFloat($("entry").value)||0;
    //   const stopPercent = (parseFloat($("riskdist").value)||0)/100;
    //   const risks = parsePercents($("risks").value);
      
    //   if(!entry || risks.length === 0 || stopPercent <= 0) return;
      
    //   // Calculate stop loss distance
    //   const stopDistance = entry * stopPercent; // How much price needs to drop to hit SL
    //   const stopPrice = entry - stopDistance;
      
    //   // Generate take-profit levels based on proper risk-reward ratios
    //   const takeProfits = [];
      
    //   risks.forEach(riskPercent => {
    //     const riskPercentage = riskPercent * 100; // Convert back to percentage
        
    //     // Define risk-reward ratios based on risk level
    //     let rrRatios;
    //     console.log(riskPercentage);
    //     if (riskPercentage <= 1) {
    //       // Conservative: Higher R:R ratios (2:1, 3:1, 4:1)
    //       rrRatios = [2, 2.5, 3];
    //     } else if (riskPercentage <= 2) {
    //       // Moderate: Good R:R ratios (1.5:1, 2.5:1, 3.5:1)
    //       rrRatios = [riskPercentage*1.5, riskPercentage*2.5, riskPercentage*3];
    //     } else {
    //       rrRatios = [riskPercentage*1.5, riskPercentage*2.5, riskPercentage*3];
    //     }
        
    //     // Calculate take-profit levels based on risk-reward ratios
    //     rrRatios.forEach(rr => {
    //       // TP = Entry + (Stop Distance × Risk:Reward Ratio)
    //       const tp = Math.round(entry + (stopDistance * rr));
    //       if (!takeProfits.includes(tp)) {
    //         takeProfits.push(tp);
    //       }
    //     });
    //   });
      
    //   // Sort and update the TP field
    //   takeProfits.sort((a, b) => a - b);
    //   $("tps").value = takeProfits.join(',');
    // }

    function autoCalculateTakeProfits() {
  const entry = parseFloat($("entry").value) || 0;
  let stopPercent = (parseFloat($("riskdist").value) || 0) / 100;
  let risks = parsePercents($("risks").value);

  if (!entry || risks.length === 0 || stopPercent <= 0) return;

  // Enforce max risk 2%
  risks = risks.map(r => Math.min(r, 0.02));

  // Calculate stop loss distance & price
  const stopDistance = entry * stopPercent;
  const stopPrice = entry - stopDistance;

  const takeProfits = [];

  risks.forEach(riskPercent => {
    const riskPct = riskPercent * 100; // Convert to %
    let rrRatios = [];

    // Conservative setups always enforce RR >= 2
    if (riskPct <= 1) {
      rrRatios = [2, 2.5, 3]; 
    } else if (riskPct <= 2) {
      rrRatios = [2, 2.5, 3.5]; 
    } else {
      rrRatios = [2, 3, 4]; 
    }

    rrRatios.forEach(rr => {
      // Ensure minimum RR = 2
      const safeRR = Math.max(rr, 2);
      const tp = Math.round(entry + (stopDistance * safeRR));

      if (!takeProfits.includes(tp)) {
        takeProfits.push(tp);
      }
    });
  });

  // Sort and output
  takeProfits.sort((a, b) => a - b);
  $("tps").value = takeProfits.join(',');

  // Also show stop price for clarity
  // $("sl").value = stopPrice.toFixed(2);
}


    function calc(){
      const capital = parseFloat($("capital").value)||0;
      const entry = parseFloat($("entry").value)||0;
      const stopPercent = (parseFloat($("riskdist").value)||0)/100;
      const stop = entry - (entry * stopPercent);
      const risks = parsePercents($("risks").value);
      const tps = parsePrices($("tps").value);
      const riskPerCoin = entry - stop;

      const tbody = $("results").querySelector('tbody');
      tbody.innerHTML = '';

      if(riskPerCoin <= 0 || entry<=0 || stop<=0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="danger" style="text-align:center">Invalid prices. Stop must be below Entry.</td>`;
        tbody.appendChild(tr);
        return;
      }

      // Calculate total number of rows to distribute capital
      const totalRows = risks.length * tps.length;
      const positionSizePerRow = capital / totalRows;
      
      let totalStopLoss = 0;
      let totalProfit = 0;

      risks.forEach(rp=>{
        const risk$ = capital * rp;
        const posBTC = positionSizePerRow / entry;  // BTC for this specific position
        const posUSDT = positionSizePerRow;         // Equal portion of capital
        
        // Calculate the required stop loss for this risk level and position size
        const requiredStop = entry - (risk$ / (capital / entry));
        const stopLoss = risk$ / totalRows; // Stop loss amount per position

        tps.forEach(tp=>{
          const profitPerCoin = tp - entry;
          const profit = profitPerCoin * posBTC;
          const rr = profit / (risk$ / totalRows); // Risk per position
          
          // Add to totals
          totalStopLoss += stopLoss;
          totalProfit += profit;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmt(rp*100,2)}%</td>
            <td>$${fmt(stopLoss,2)}</td>
            <td>$${fmt(posUSDT,0)}</td>
            <td>${posBTC.toFixed(6)} </td>
            <td>${fmt(requiredStop,2)}</td>
            <td>${fmt(tp,2)}</td>
            <td>$${fmt(profit,2)}</td>
            <td>${fmt(rr,2)} : 1</td>
          `;
          tbody.appendChild(tr);
        });
      });
      
      // Update totals in footer
      const totalsElement = document.getElementById('totals');
      if (totalsElement) {
        totalsElement.innerHTML = `Total Stop Loss: $${fmt(totalStopLoss,2)} | Total Profit: $${fmt(totalProfit,2)}`;
      }
      
      // Check if total stop loss exceeds 2% of capital and show warning
      const riskWarning = document.getElementById('risk-warning');
      const maxAllowedRisk = capital * 0.02; // 2% of capital
      
      if (totalStopLoss > maxAllowedRisk && capital > 0) {
        riskWarning.style.display = 'block';
        // Update warning text with specific amounts
        const warningText = riskWarning.querySelector('.warning-text');
        const excessRisk = ((totalStopLoss / capital) * 100).toFixed(1);
        warningText.textContent = `Too Risky - Total Stop Loss (${excessRisk}%) exceeds 2% of capital`;
      } else {
        riskWarning.style.display = 'none';
      }
    }



    function toSVG(){
      const table = document.getElementById('results');
      const headers = ['Stop Loss %', 'Stop Loss $', 'Investment (USDT)', 'Investment (Crypto)', 'Stop Exit', 'Take Profit Exit', 'Profit $', 'R:R'];
      const rows = [];
      
      document.querySelectorAll('#results tbody tr').forEach(tr=>{
        const cells = [...tr.children].map(td=>td.innerText);
        rows.push(cells);
      });

      // Check if warning is visible
      const riskWarning = document.getElementById('risk-warning');
      const showWarning = riskWarning && riskWarning.style.display !== 'none';
      const warningHeight = showWarning ? 50 : 0;

      // SVG dimensions
      const cellWidth = 120;
      const cellHeight = 35;
      const headerHeight = 40;
      const width = headers.length * cellWidth;
      const height = headerHeight + (rows.length * cellHeight) + 80 + warningHeight; // Extra space for title and warning

      // Create SVG
      let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <style>
            .header { font: 12px ui-sans-serif, system-ui; fill: #9aa7c7; font-weight: 600; }
            .cell { font: 11px ui-sans-serif, system-ui; fill: #e8ecf2; }
            .title { font: 16px ui-sans-serif, system-ui; fill: #e8ecf2; font-weight: 700; }
            .warning { font: 12px ui-sans-serif, system-ui; fill: #ff6b6b; font-weight: 600; }
            .warning-icon { font: 14px ui-sans-serif, system-ui; fill: #ff6b6b; }
            .bg { fill: #121722; }
            .header-bg { fill: #0f1422; stroke: #1d2740; stroke-width: 1; }
            .cell-bg { fill: #0f1422; stroke: #1d2740; stroke-width: 1; }
            .warning-bg { fill: rgba(255,107,107,0.1); stroke: #ff6b6b; stroke-width: 2; }
          </style>
        </defs>
        <rect width="100%" height="100%" class="bg"/>
        <text x="${width/2}" y="25" text-anchor="middle" class="title">Crypto Trade Risk Calculator</text>`;

      // Add warning if visible
      let tableStartY = 50;
      if (showWarning) {
        const warningText = riskWarning.querySelector('.warning-text');
        const warningMsg = warningText ? warningText.textContent : 'Too Risky - Total Stop Loss exceeds 2% of capital';
        
        // Warning background
        const warningY = 45;
        const warningBoxWidth = width - 40;
        const warningBoxX = 20;
        svg += `<rect x="${warningBoxX}" y="${warningY}" width="${warningBoxWidth}" height="35" rx="8" class="warning-bg"/>`;
        
        // Warning icon and text
        svg += `<text x="${warningBoxX + 15}" y="${warningY + 22}" class="warning-icon">⚠️</text>`;
        svg += `<text x="${warningBoxX + 35}" y="${warningY + 22}" class="warning">${warningMsg}</text>`;
        
        tableStartY = 90; // Move table down
      }

      // Header row
      headers.forEach((header, i) => {
        const x = i * cellWidth;
        const y = tableStartY;
        svg += `<rect x="${x}" y="${y}" width="${cellWidth}" height="${headerHeight}" class="header-bg"/>
                <text x="${x + cellWidth/2}" y="${y + headerHeight/2 + 4}" text-anchor="middle" class="header">${header}</text>`;
      });

      // Data rows
      rows.forEach((row, rowIndex) => {
        const y = tableStartY + headerHeight + (rowIndex * cellHeight);
        row.forEach((cell, colIndex) => {
          const x = colIndex * cellWidth;
          svg += `<rect x="${x}" y="${y}" width="${cellWidth}" height="${cellHeight}" class="cell-bg"/>
                  <text x="${x + cellWidth/2}" y="${y + cellHeight/2 + 4}" text-anchor="middle" class="cell">${cell}</text>`;
        });
      });

      // Add totals at bottom
      const totalsElement = document.getElementById('totals');
      if (totalsElement && totalsElement.innerHTML) {
        const totalsY = tableStartY + headerHeight + (rows.length * cellHeight) + 20;
        svg += `<text x="${width/2}" y="${totalsY}" text-anchor="middle" class="header">${totalsElement.innerText}</text>`;
      }

      svg += '</svg>';

      // Download SVG
      const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = 'risk_calculator.svg';
      document.body.appendChild(a); 
      a.click(); 
      a.remove();
      URL.revokeObjectURL(url);
    }

    function reset(){
      $("capital").value = 5000;
      $("entry").value = 111500;
      $("riskdist").value = 3;
      $("risks").value = '1,2';
      autoCalculateTakeProfits(); // Auto-calculate TPs based on reset risk values
      calc();
    }

    // Auto-calculate TPs when risks or entry changes
    ['risks', 'entry'].forEach(id=>{
      $(id).addEventListener('input', ()=>{
        autoCalculateTakeProfits();
        calc();
      });
      $(id).addEventListener('change', ()=>{
        autoCalculateTakeProfits();
        calc();
      });
    });
    
    // Regular calculation for other fields
    ['capital','riskdist','tps'].forEach(id=>{
      $(id).addEventListener('input', calc);
      $(id).addEventListener('change', calc);
    });

    $("download").addEventListener('click', toSVG);
    $("reset").addEventListener('click', reset);

    calc();
  </script>
</body>
</html>
