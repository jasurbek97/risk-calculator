<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risk Calculator</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#121722; --muted:#778; --text:#e8ecf2; --accent:#6ee7b7; --accent2:#7aa2ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b0d12,#0c1018 40%,#0b0d12);color:var(--text);min-height:100vh}
    
    /* Responsive Container */
    .container{max-width:1200px;margin:16px auto;padding:12px}
    @media(min-width:480px){.container{margin:20px auto;padding:16px}}
    @media(min-width:768px){.container{margin:40px auto;padding:24px}}
    
    .card{background:var(--panel);border:1px solid #1e2635;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    @media(min-width:768px){.card{border-radius:18px}}
    
    /* Responsive Header */
    .header{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:16px 16px 8px 16px;flex-direction:column}
    @media(min-width:640px){.header{flex-direction:row;align-items:center;gap:16px}}
    @media(min-width:768px){.header{padding:22px 22px 10px 22px}}
    
    .title{font-size:18px;font-weight:700;letter-spacing:.2px;margin-bottom:8px}
    @media(min-width:480px){.title{font-size:20px}}
    @media(min-width:768px){.title{font-size:22px;margin-bottom:0}}
    
    .subtitle{font-size:13px;color:var(--muted);line-height:1.4;margin-bottom:12px}
    @media(min-width:640px){.subtitle{margin-bottom:0}}
    @media(min-width:768px){.subtitle{font-size:14px}}
    
    /* Responsive Grid */
    .grid{display:grid;gap:12px;padding:0 16px 16px 16px}
    @media(min-width:480px){.grid{gap:14px}}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:768px){.grid{padding:0 22px 22px 22px}}
         @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    
    .grid.single{grid-template-columns:1fr}
    
    /* Responsive Typography */
    label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:500}
    @media(min-width:768px){label{font-size:12px}}
    
    input,textarea,button{font:inherit}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #243047;background:#0f1320;color:var(--text);font-size:14px}
    @media(min-width:768px){.input{padding:12px;border-radius:12px;font-size:15px}}
    
    /* Responsive Buttons */
    .row{display:flex;gap:8px;align-items:center;width:100%;justify-content:flex-end}
    @media(min-width:640px){.row{width:auto}}
    
    .btn{cursor:pointer;border:1px solid #22304a;background:#0f1422;color:#dfe6f3;padding:8px 12px;border-radius:10px;transition:.15s ease;font-size:13px;white-space:nowrap;flex:1}
    @media(min-width:640px){.btn{flex:initial}}
    @media(min-width:768px){.btn{padding:10px 14px;border-radius:12px;font-size:14px}}
    .btn:hover{transform:translateY(-1px);border-color:#2f436d}
    .btn.accent{border-color:#1b3e36;background:#0f1f1a;color:#d8f5ea}
    .btn.accent:hover{box-shadow:0 6px 20px rgba(110,231,183,.15)}
    .btn.ghost{background:transparent}

    /* Responsive Table */
    .table-container{padding:0 16px 16px 16px;overflow-x:auto}
    @media(min-width:768px){.table-container{padding:0 22px 18px 22px}}
    
    table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:700px}
    @media(min-width:768px){table{border-spacing:0 10px;min-width:800px}}
    
    th,td{padding:8px 6px;text-align:left;font-size:10px}
    @media(min-width:480px){th,td{padding:10px 8px;font-size:11px}}
    @media(min-width:768px){th,td{padding:12px 14px;font-size:12px}}
    @media(min-width:1024px){th,td{font-size:13px}}
    
    th{color:#9aa7c7;border-bottom:1px solid #23314c;font-weight:600}
    tr{background:#0f1422;border:1px solid #1d2740}
    tr td:first-child, tr th:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tr td:last-child, tr th:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
    @media(min-width:768px){
      tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
      tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    }

    /* Responsive Pills */
    .pills{padding:8px 16px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    @media(min-width:768px){.pills{padding:12px 22px 4px 22px;gap:10px}}
    
    .pill{display:inline-block;padding:3px 6px;border-radius:999px;background:#0d192e;border:1px solid #22324f;color:#cfe;font-size:9px}
    @media(min-width:480px){.pill{padding:3px 8px;font-size:10px}}
    @media(min-width:768px){.pill{padding:4px 10px;font-size:11px}}
    
    /* Responsive Footer */
    .foot{padding:12px 16px 16px 16px;color:#9aa7c7;font-size:10px;display:flex;flex-direction:column;gap:8px}
    @media(min-width:768px){.foot{padding:12px 22px 22px 22px;font-size:12px;flex-direction:row;justify-content:space-between;align-items:center;gap:16px}}
    
    .muted{color:#9aa7c7}
    .danger{color:var(--danger)}
    
    #totals{font-weight:600;color:var(--text);font-size:10px}
    @media(min-width:768px){#totals{font-size:12px}}
    
    /* Mobile Table Optimizations */
    @media(max-width:600px){
      table{min-width:600px}
      th:nth-child(n+6), td:nth-child(n+6){font-size:9px}
    }
    
    /* Table scroll hint */
    .table-scroll-hint{display:block;text-align:center;font-size:9px;color:var(--muted);padding:4px 16px;border-top:1px solid #1e2635}
    @media(min-width:768px){.table-scroll-hint{display:none}}
    
    /* Landscape phone optimizations */
    @media(max-width:767px) and (orientation:landscape){
      .container{margin:8px auto;padding:8px}
      .header{padding:12px 16px 6px 16px}
      .grid{padding:0 16px 12px 16px;gap:10px}
      .pills{padding:6px 16px}
      .table-container{padding:0 16px 12px 16px}
      .foot{padding:8px 16px 12px 16px}
    }
    
    /* Very small screens */
    @media(max-width:360px){
      .title{font-size:16px}
      .btn{padding:6px 8px;font-size:12px}
      th,td{padding:6px 4px;font-size:9px}
      table{min-width:500px}
    }
    
    /* Risk Warning Styles */
    .risk-warning{
      margin:8px 16px;
      padding:12px;
      background:rgba(255,107,107,0.1);
      border:1px solid var(--danger);
      border-radius:10px;
      animation:warningPulse 2s infinite;
    }
    @media(min-width:768px){
      .risk-warning{
        margin:12px 22px;
        padding:16px;
        border-radius:12px;
      }
    }
    
    .warning-content{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:center;
    }
    
    .warning-icon{
      font-size:16px;
      animation:warningShake 1s infinite;
    }
    @media(min-width:768px){
      .warning-icon{font-size:18px}
    }
    
    .warning-text{
      color:var(--danger);
      font-weight:600;
      font-size:12px;
    }
    @media(min-width:768px){
      .warning-text{font-size:14px}
    }
    
    @keyframes warningPulse{
      0%, 100%{border-color:var(--danger);background:rgba(255,107,107,0.1)}
      50%{border-color:#ff8a8a;background:rgba(255,107,107,0.2)}
    }
    
    @keyframes warningShake{
      0%, 100%{transform:translateX(0)}
      25%{transform:translateX(-2px)}
      75%{transform:translateX(2px)}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Crypto Trade Risk Calculator</div>
          <div class="subtitle">Size positions by risk, not feelings. Set capital, entry, take-profits—Stop-Loss auto-calculates.</div>
        </div>
        <div class="row">
          <button id="reset" class="btn ghost" title="Reset to defaults">Reset</button>
          <button id="download" class="btn accent" title="Download table as JPG">Download JPG</button>
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="capital">Capital (USDT)</label>
          <input id="capital" type="number" class="input" value="5000" min="0" step="0.01">
        </div>
        <div>
          <label for="entry">Entry Price</label>
          <input id="entry" type="number" class="input" value="111500" min="0" step="0.01">
        </div>
        
        <div>
          <label for="risks">Risk % per Trade (numbers only)</label>
          <input id="risks" type="number" class="input" value="1" min="0.1" max="10" step="0.1" placeholder="Enter risk percentage (0.1-10)">
        </div>
        <div>
          <label for="rrRatios">Risk-Reward Ratios (comma-separated)</label>
          <input id="rrRatios" type="text" class="input" value="10,15,20,25,30" placeholder="e.g., 10, 15, 20, 25, 30">
        </div>
        <div>
          <label for="rowCounts">Rows per Risk % (numbers only)</label>
          <input id="rowCounts" type="number" class="input" value="5" min="1" max="100" placeholder="Enter number of rows (1-100)">
        </div>
      </div>



      <div class="pills">
        <span class="pill">RR ≥ 2 preferred</span>
        <span class="pill">Risk only 1–10%/trade</span>
        <span class="pill danger">Never move SL away</span>
      </div>

      <div id="risk-warning" class="risk-warning" style="display: none;">
        <div class="warning-content">
          <span class="warning-icon">⚠️</span>
          <span class="warning-text">Too Risky - Total Stop Loss exceeds 10% of capital</span>
        </div>
      </div>

      <div class="table-container">
        <table id="results">
          <thead>
            <tr>
              <th>#</th>
              <th>Risk %</th>
              <th>Risk $</th>
              <th>Deposit (USDT)</th>
              <th>Deposit (Crypto)</th>
              <th>Stop-Loss Exit</th>
              <th>Take-Profit Exit</th>
              <th>Profit $</th>
              <th>R:R</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-scroll-hint">← Scroll horizontally to see all columns →</div>
      </div>

      <div class="foot">
        <span>Stop = Entry − (Entry × Risk%). Position = (capital × risk%) / (Entry − Stop).</span>
        <span id="totals"></span>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n, d=2)=> {
      // Ensure n is a valid number
      const num = Number(n);
      if (!isFinite(num)) return '0';
      
      // Ensure d is within valid range (0-20)
      const digits = Math.max(0, Math.min(20, Math.floor(Number(d) || 0)));
      
      try {
        return num.toLocaleString(undefined, {
          maximumFractionDigits: digits, 
          minimumFractionDigits: (num % 1 ? Math.min(digits, 2) : 0)
        });
      } catch (e) {
        return num.toString();
      }
    };

    function parsePercents(str){
      return String(str)
        .split(',')
        .map(s=>parseFloat(s.trim()))
        .filter(v=>!isNaN(v) && v>0)
        .map(v=>v/100);
    }
    function parsePrices(str){
      return String(str)
        .split(',')
        .map(s=>parseFloat(s.trim()))
        .filter(v=>!isNaN(v) && v>0);
    }
    
    // This function is no longer needed since calc() generates rows directly
    function autoCalculateTakeProfits() {
       // Just trigger calc() to regenerate the table
       calc();
     }


    function calc(){
       const capital = parseFloat($("capital").value)||0;
       const entry = parseFloat($("entry").value)||0;
       // Fixed 3% stop loss
       const stopPercent = 0.03;
       const stop = entry - (entry * stopPercent);
       const riskValue = parseFloat($("risks").value) || 1;
       const risks = [riskValue / 100]; // Convert to decimal percentage
       const rrRatiosInput = $("rrRatios").value;
       const rowCountsInput = $("rowCounts").value;
       const riskPerCoin = entry - stop;

      const tbody = $("results").querySelector('tbody');
      tbody.innerHTML = '';

      if(entry <= 0 || riskValue <= 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="9" class="danger" style="text-align:center">Invalid entry price or risk percentage.</td>`;
        tbody.appendChild(tr);
        return;
      }

      // Parse row count from input (single number for all risks)
      const rowCountPerRisk = parseInt(rowCountsInput) || 5;

      // Parse RR ratios from input
      let rrRatios = [];
      if (rrRatiosInput && rrRatiosInput.trim()) {
        rrRatios = String(rrRatiosInput)
          .split(',')
          .map(s => parseFloat(s.trim()))
          .filter(v => !isNaN(v) && v > 0);
      }
      
      if (rrRatios.length === 0) {
        rrRatios = [2, 2.5, 3];
      }
      rrRatios = rrRatios.map(rr => Math.max(rr, 2));

      // Calculate total number of rows based on row count (single risk percentage)
      const totalRows = rowCountPerRisk;

      const positionSizePerRow = capital / totalRows;
      
      let totalStopLoss = 0;
      let totalProfit = 0;

                  // Generate rows for the single risk percentage
      const rp = risks[0]; // Single risk percentage
      const risk$ = capital * rp;
      
      // Store row data to sort by take-profit later
      const rowsData = [];
          
      // Generate the specified number of rows for this risk
      for (let i = 0; i < rowCountPerRisk; i++) {
        // Use RR ratios cyclically
        const rrIndex = i % rrRatios.length;
        const baseRR = rrRatios[rrIndex];
        
        // Add variation for additional cycles
        const cycle = Math.floor(i / rrRatios.length);
        const adjustedRR = baseRR + (cycle * 0.8);
        
        // Calculate take-profit price
        const tp = Math.round(entry + (entry * adjustedRR) / 100);
        
        const posBTC = positionSizePerRow / entry;
        const posUSDT = positionSizePerRow;
        
        // Calculate the stop loss price: Entry - (Risk % of Entry)
        const stopLossPrice = entry - (entry * rp); // rp is already the risk percentage as decimal
        const stopLoss = risk$ / totalRows; // Stop loss amount per position

        const profitPerCoin = tp - entry;
        const profit = profitPerCoin * posBTC;
        const rr = profit / stopLoss; // Risk per position
        
        // Add to totals
        totalStopLoss += stopLoss;
        totalProfit += profit;
        
        // Store row data for sorting
        rowsData.push({
          rp,
          stopLoss,
          posUSDT,
          posBTC,
          stopLossPrice,
          tp,
          profit,
          rr
        });
      }

      // Sort rows by take-profit price (ascending)
      rowsData.sort((a, b) => a.tp - b.tp);

      // Add sorted rows to table with correct row numbers
      rowsData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${fmt(row.rp*100,2)}%</td>
          <td>$${fmt(row.stopLoss,2)}</td>
          <td>$${fmt(row.posUSDT,0)}</td>
          <td>${row.posBTC.toFixed(6)} </td>
          <td>${fmt(row.stopLossPrice,2)}</td>
          <td>${fmt(row.tp,2)}</td>
          <td>$${fmt(row.profit,2)}</td>
          <td>${row.rr % 1 === 0 ? row.rr.toFixed(0) : row.rr.toFixed(1)} : 1</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Update totals in footer
      const totalsElement = document.getElementById('totals');
      if (totalsElement) {
        totalsElement.innerHTML = `Total Stop Loss: $${fmt(totalStopLoss,2)} | Total Profit: $${fmt(totalProfit,2)}`;
      }
      
      // Check if total stop loss exceeds 2% of capital and show warning
      const riskWarning = document.getElementById('risk-warning');
      const maxAllowedRisk = capital * 0.1; // 10% of capital
      
      if (totalStopLoss > maxAllowedRisk && capital > 0) {
        riskWarning.style.display = 'block';
        // Update warning text with specific amounts
        const warningText = riskWarning.querySelector('.warning-text');
        const excessRisk = ((totalStopLoss / capital) * 100).toFixed(1);
        warningText.textContent = `Too Risky - Total Stop Loss (${excessRisk}%) exceeds 10% of capital`;
      } else {
        riskWarning.style.display = 'none';
      }
    }



    function toJPG(){
      const table = document.getElementById('results');
      const headers = ['#', 'Risk %', 'Risk $', 'Deposit (USDT)', 'Deposit (Crypto)', 'Stop-Loss Exit', 'Take-Profit Exit', 'Profit $', 'R:R'];
      const rows = [];
      
      document.querySelectorAll('#results tbody tr').forEach(tr=>{
        const cells = [...tr.children].map(td=>td.innerText);
        rows.push(cells);
      });

      // Get capital and entry price values
      const capital = parseFloat($("capital").value) || 0;
      const entry = parseFloat($("entry").value) || 0;

      // Check if warning is visible
      const riskWarning = document.getElementById('risk-warning');
      const showWarning = riskWarning && riskWarning.style.display !== 'none';
      const warningHeight = showWarning ? 50 : 0;

      // Canvas dimensions
      const cellWidth = 120;
      const cellHeight = 35;
      const headerHeight = 40;
      const width = headers.length * cellWidth;
      const height = headerHeight + (rows.length * cellHeight) + 120 + warningHeight;

      // Create canvas
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      // Set high DPI for crisp rendering
      const dpr = window.devicePixelRatio || 1;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      ctx.scale(dpr, dpr);

      // Fill background
      ctx.fillStyle = '#121722';
      ctx.fillRect(0, 0, width, height);

      // Helper function to draw text with better positioning
      function drawText(text, x, y, style = {}) {
        ctx.save();
        ctx.fillStyle = style.color || '#e8ecf2';
        ctx.font = style.font || '11px ui-sans-serif, system-ui, sans-serif';
        ctx.textAlign = style.align || 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, x, y);
        ctx.restore();
      }

      // Draw title
      drawText('Crypto Trade Risk Calculator', width/2, 25, {
        color: '#e8ecf2',
        font: '700 16px ui-sans-serif, system-ui, sans-serif'
      });

      // Draw subtitle
      drawText(`Capital: $${fmt(capital, 0)} USDT | Entry Price: $${fmt(entry, 2)}`, width/2, 45, {
        color: '#9aa7c7',
        font: '500 12px ui-sans-serif, system-ui, sans-serif'
      });

      let tableStartY = 70;

      // Draw warning if visible
      if (showWarning) {
        const warningText = riskWarning.querySelector('.warning-text');
        const warningMsg = warningText ? warningText.textContent : 'Too Risky - Total Stop Loss exceeds 2% of capital';
        
        const warningY = 65;
        const warningBoxWidth = width - 40;
        const warningBoxX = 20;

        // Warning background
        ctx.fillStyle = 'rgba(255,107,107,0.1)';
        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(warningBoxX, warningY, warningBoxWidth, 35, 8);
        ctx.fill();
        ctx.stroke();

        // Warning text
        drawText('⚠️', warningBoxX + 15, warningY + 17.5, {
          color: '#ff6b6b',
          font: '14px ui-sans-serif, system-ui, sans-serif'
        });
        
        drawText(warningMsg, warningBoxX + 35, warningY + 17.5, {
          color: '#ff6b6b',
          font: '600 12px ui-sans-serif, system-ui, sans-serif',
          align: 'left'
        });

        tableStartY = 110;
      }

      // Draw header row
      headers.forEach((header, i) => {
        const x = i * cellWidth;
        const y = tableStartY;
        
        // Header background
        ctx.fillStyle = '#0f1422';
        ctx.strokeStyle = '#1d2740';
        ctx.lineWidth = 1;
        ctx.fillRect(x, y, cellWidth, headerHeight);
        ctx.strokeRect(x, y, cellWidth, headerHeight);
        
        // Header text
        drawText(header, x + cellWidth/2, y + headerHeight/2, {
          color: '#9aa7c7',
          font: '600 12px ui-sans-serif, system-ui, sans-serif'
        });
      });

      // Draw data rows
      rows.forEach((row, rowIndex) => {
        const y = tableStartY + headerHeight + (rowIndex * cellHeight);
        row.forEach((cell, colIndex) => {
          const x = colIndex * cellWidth;
          
          // Cell background
          ctx.fillStyle = '#0f1422';
          ctx.strokeStyle = '#1d2740';
          ctx.lineWidth = 1;
          ctx.fillRect(x, y, cellWidth, cellHeight);
          ctx.strokeRect(x, y, cellWidth, cellHeight);
          
          // Cell text
          drawText(cell, x + cellWidth/2, y + cellHeight/2, {
            color: '#e8ecf2',
            font: '11px ui-sans-serif, system-ui, sans-serif'
          });
        });
      });

      // Draw totals at bottom
      const totalsElement = document.getElementById('totals');
      if (totalsElement && totalsElement.innerHTML) {
        const totalsY = tableStartY + headerHeight + (rows.length * cellHeight) + 20;
        drawText(totalsElement.innerText, width/2, totalsY, {
          color: '#9aa7c7',
          font: '600 12px ui-sans-serif, system-ui, sans-serif'
        });
      }

      // Convert canvas to JPG and download
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'risk_calculator.jpg';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }, 'image/jpeg', 0.95); // 95% quality JPG
    }

    function reset(){
       $("capital").value = 5000;
       $("entry").value = 111500;
       $("risks").value = '1';
       $("rrRatios").value = '10,15,20,25,30';
       $("rowCounts").value = '5';
       autoCalculateTakeProfits(); // Auto-calculate TPs based on reset risk values
       calc();
     }

         // Auto-calculate TPs when risks, entry, rrRatios, or rowCounts changes
     ['risks', 'entry', 'rrRatios', 'rowCounts'].forEach(id=>{
       $(id).addEventListener('input', ()=>{
         autoCalculateTakeProfits();
         calc();
       });
       $(id).addEventListener('change', ()=>{
         autoCalculateTakeProfits();
         calc();
       });
     });
     
     // Regular calculation for other fields
     ['capital'].forEach(id=>{
       $(id).addEventListener('input', calc);
       $(id).addEventListener('change', calc);
     });

    $("download").addEventListener('click', toJPG);
    $("reset").addEventListener('click', reset);

    calc();
  </script>
</body>
</html>
